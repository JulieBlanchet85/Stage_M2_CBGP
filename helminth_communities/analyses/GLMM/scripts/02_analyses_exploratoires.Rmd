---
title: "Exploration du parasitisme chez les mulots"
author: "Analyse exploratoire R"
output: html_document
---

# Analyses exploratoires

## üì¶ Chargement des packages

```{r, include = FALSE}
library(tidyverse)
library(vegan)
library(FactoMineR)
library(factoextra)
library(cooccur)
library(igraph)
library(vegan)
library(reshape2)
library(ggplot2)
library(ggcorrplot)
```

## üìÑ Chargement des donn√©es

```{r}
df <-read.csv(here::here("data/derived_data/20250522_jd_complet.csv"), sep = ",")

# S√©paration des blocs de donn√©es
parasites <- df[, c("syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna","syphacia_frederici","hydatigera_parva","aspiculuris_tetraptera","skrjabinotaenia_lobata", "trichuris")]
infos <- df[, c("demogroup","sexe", "SMI", "poids", "longueur_tete_corps", "richesse_spe_AP", "habitat1", "habitat2")]
```

## Plot distribution des helminthes

```{r}
df_long <- parasites %>%     
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
  filter(variable %in% c("heligmosomoides_polygyrus", "syphacia_stroma", "syphacia_frederici"))


# pour mettre les donn√©es au format long donc pour que une ligne ne repr√©sente plus un individu, une ligne c'est la valeur d'une varaible pour un individu, don pour chaque individus on va avoir plusieurs ligne, une par variable

# On trace les histogrammes
ggplot(data = df_long, aes(x = value)) +
  geom_histogram(fill = '#69b3a2', color = 'white', bins = 30) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal()
```

## Pr√©valences des helminthes

```{r}
##Pr√©valence de chaque parasite
prevalence <- colSums(parasites > 0) / nrow(parasites) * 100
prevalence

## % d'infect√©s par au - 1 parasite
prevalence_globale <- sum(rowSums(parasites > 0) > 0) / nrow(parasites) * 100
prevalence_globale
```

```{r}
## Pr√©valence par habitat
# S√©parer les donn√©es par habitat
parasites_par_habitat <- split(parasites, df$habitat1)

# Calculer la pr√©valence pour chaque parasite dans chaque habitat
prevalence_par_habitat <- lapply(parasites_par_habitat, function(x) {
  colSums(x > 0) / nrow(x) * 100
})

prevalence_par_habitat # en %
```

```{r}
## Test si diff√©rences significatives de pr√©valence entre les habitats 

# Test exact de Fisher pour chaque parasite
resultats_fisher <- lapply(names(parasites), function(parasite) {
  table_contingence <- table(df$habitat1, df[[parasite]] > 0)
  
  # Test de Fisher
  test <- fisher.test(table_contingence)
  
  data.frame(
    Parasite = parasite,
    P_value = test$p.value
  )
})

# Rassembler les r√©sultats
resultats_df <- do.call(rbind, resultats_fisher)

# Correction FDR
resultats_df$P_value_holm <- p.adjust(resultats_df$P_value, method = "holm")

# Affichage
print(resultats_df)


```

```{r}
## Comparaisons des pr√©valence pour S. frederici selon les habitats
df$infected <- df$syphacia_frederici > 0
# Obtenir les habitats
habitats <- unique(df$habitat1)

# Comparaisons deux √† deux avec Fisher
pairwise_fisher <- combn(habitats, 2, function(pair) {
  # Sous-ensemble des donn√©es pour les deux habitats
  subset_data <- df[df$habitat1 %in% pair, ]
  
  # Tableau de contingence
  table_test <- table(subset_data$habitat1, subset_data$infected)
  
  # Test exact de Fisher
  test <- fisher.test(table_test)
  
  # R√©sultat
  data.frame(
    Habitat1 = pair[1],
    Habitat2 = pair[2],
    P_value = test$p.value
  )
}, simplify = FALSE)

# Combine les r√©sultats
pairwise_df <- do.call(rbind, pairwise_fisher)

# Correction FDR
pairwise_df$P_value_adj <- p.adjust(pairwise_df$P_value, method = "fdr")

# Affichage
print(pairwise_df)

```

```{r}
## Plot
prevalence_plot_data <- df %>%
  mutate(infected = syphacia_frederici > 0) %>%
  group_by(habitat1) %>%
  summarise(
    n = n(),
    infected_n = sum(infected),
    prevalence = infected_n / n * 100
  )


ggplot(prevalence_plot_data, aes(x = habitat1, y = prevalence)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(round(prevalence, 1), "%")), vjust = -0.5) +
  ylim(0, 100) +
  labs(
    title = "Pr√©valence de Syphacia frederici par habitat",
    x = "Habitat",
    y = "Pr√©valence (%)"
  ) +
  theme_minimal()

```

## Intensit√© d'infection des helminthes

```{r}
parasite_names <- c(
  "syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna",
  "syphacia_frederici", "hydatigera_parva", "aspiculuris_tetraptera",
  "skrjabinotaenia_lobata", "trichuris"
)

# Stockage des r√©sultats
kruskal_results <- list()

for (parasite in parasite_names) {
  # Filtrer que les infect√©s
  df_infectes <- df %>%
    filter(.data[[parasite]] > 0)
  
  # V√©rifier qu'il y a au moins 2 habitats avec des infect√©s
  if (length(unique(df_infectes$habitat1)) >= 2) {
    # Kruskal-Wallis
    kw <- kruskal.test(df_infectes[[parasite]] ~ df_infectes$habitat1)
    
    # Stocker les r√©sultats
    kruskal_results[[parasite]] <- data.frame(
      Parasite = parasite,
      N_infectes = nrow(df_infectes),
      P_value = kw$p.value
    )
  } else {
    kruskal_results[[parasite]] <- data.frame(
      Parasite = parasite,
      N_infectes = nrow(df_infectes),
      P_value = NA
    )
  }
}

# Rassembler les r√©sultats
kruskal_df <- do.call(rbind, kruskal_results)

# Correction FDR
kruskal_df$P_value_adj <- p.adjust(kruskal_df$P_value, method = "holm")

print(kruskal_df)
```

## Corr√©lations

```{r}
vars <- df[, c("SMI", "poids", "richesse_spe_AP")]
cor_matrix <- cor(vars, use = "pairwise.complete.obs", method = "spearman")
print(cor_matrix)
```

```{r}
# Fonction pour extraire les p-values de cor.test
cor_pmat <- function(x) {
  n <- ncol(x)
  p.mat <- matrix(NA, n, n)
  colnames(p.mat) <- rownames(p.mat) <- colnames(x)
  
  for (i in 1:n) {
    for (j in 1:n) {
      test <- cor.test(x[, i], x[, j])
      p.mat[i, j] <- test$p.value
    }
  }
  return(p.mat)
}

p_matrix <- cor_pmat(vars)
print(p_matrix)
```

```{r}
# Heatmap avec significativit√©
ggcorrplot::ggcorrplot(cor_matrix, method = "square", type = "lower",
           lab = TRUE, lab_size = 4,
           p.mat = p_matrix, sig.level = 0.05,
           insig = "blank", colors = c("#6D9EC1", "grey", "#E46726"))
```

## Indices de diversit√©

### Richesse sp√©cifique en helminthe des mulots

```{r}
## Richesse sp√©cifique par habitat
vecteur_parasites <- c("syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna","syphacia_frederici","hydatigera_parva","aspiculuris_tetraptera","skrjabinotaenia_lobata", "trichuris")

### Convertir en pr√©sence/absence (1 = pr√©sent, 0 = absent)
df2 <- df
df2 <- df2 %>%
  mutate(across(all_of(vecteur_parasites), ~ ifelse(. > 0, 1, 0)))

### Calcul de la richesse sp√©cifique par habitat1
richesse_par_habitat <- df2 %>%
  group_by(habitat1) %>%
  summarise(richesse = sum(colSums(across(all_of(vecteur_parasites))) > 0))

print(richesse_par_habitat)
```

```{r}
## Richesse sp√©cifique calcul√© pour chaque individu

### Plot richesse sp√©cifique en fonction des habitats 
df$richesse <- rowSums(parasites > 0)

ggplot(df, aes(x = richesse, fill = habitat1)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

ggplot(df, aes(x = richesse, fill = habitat2)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

### Test de Kruskal-Wallis
kruskal.test(richesse ~ habitat1, data = df) #üî¥ Pas de diff√©rences significatives
kruskal.test(richesse ~ habitat2, data = df) #üî¥ Pas de diff√©rences significatives
```

### Pourcentage de mulots en fonction richesse sp√©cifique

```{r}
## Pourcentage de mulots infect√©s par une, deux trois, ... esp√®ce
table(df$richesse)
df %>%
  count(richesse) %>%
  mutate(pourcentage = 100 * n / sum(n)) -> richesse_pourcent

richesse_pourcent

ggplot(richesse_pourcent, aes(x = as.factor(richesse), y = pourcentage)) +
  geom_col(fill = "steelblue") +
  labs(x = "Nombre d'esp√®ces infectantes",
       y = "Pourcentage de mulots infect√©s") +
  theme_minimal()
```

### Indice de Shannon + pi√©lou

```{r}
## Indice de Shannon, de Pi√©lou et de Simpson totaux
parasite_data <- df[, c("syphacia_stroma",
                        "heligmosomoides_polygyrus",
                        "hymenolepis_hiberna",
                        "syphacia_frederici",
                        "trichuris",
                        "hydatigera_parva",
                        "aspiculuris_tetraptera",
                        "skrjabinotaenia_lobata")]
total_abundances <- colSums(parasite_data)
shannon_global <- vegan::diversity(total_abundances, index = "shannon")
shannon_global
pielou <- shannon_global / log(length(total_abundances))
pielou
simpson_global <- vegan::diversity(total_abundances, index = "simpson")
simpson_global
```

```{r}
## Indice de Shannon pour chaque habitat
#Cet indice prend en compte lors de son calcul la richesse et l‚Äôabondance relative des esp√®ces contrairement √† la richesse sp√©cifique.
# L‚Äôindice H de Shannon varie donc en fonction du nombre d‚Äôesp√®ce et de la proportion relative de ces diff√©rentes esp√®ces. H vaudra 0 quand l‚Äô√©chantillon ne contient qu‚Äôune seule esp√®ce et augmente lorsque le nombre d‚Äôesp√®ce augmente. Plus l‚Äôindice H est √©lev√©, plus la diversit√© est grande. H sera maximal et vaudra log(S) quand toutes les esp√®ces sont √©galement repr√©sent√©es.S =richesse sp√©

table_abondance <- df %>%      # Cr√©ation table somme des  abondances par habitat1
  group_by(habitat1) %>%
  summarise(across(all_of(vecteur_parasites), sum))

mat_parasites <- as.data.frame(table_abondance[, -1]) # tableau sans habitat1
rownames(mat_parasites) <- table_abondance$habitat1

ind_shannon <- vegan::diversity(mat_parasites, index = "shannon") # Calcul indice
mat_parasites$shannon_index <- ind_shannon

## Indice de Pielou
#Permet de mesurer la r√©partition des individus au sein des esp√®ce. La valeur de l‚Äôindice d‚Äô√©quitabilit√© de Pi√©lou (J) varie entre 0 et 1 o√π 0 correspond √† la dominance d‚Äôune des esp√®ces et 1 √† l‚Äô√©quir√©partition des individus entre les diff√©rentes esp√®ces.
mat_parasites$pielou_index <- mat_parasites$shannon_index / log(richesse_par_habitat$richesse)

print(mat_parasites)
```

```{r}
## Indice de Shannon calcul√© pour chaque individu
### Enlever les lignes o√π y a aucun parasites

df3 <- df %>% filter(richesse > 0) 

### Calcul Shannon
parasites <- df3[, c("syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna","syphacia_frederici","hydatigera_parva","aspiculuris_tetraptera","skrjabinotaenia_lobata", "trichuris")]

df3$shannon <- vegan::diversity(parasites, index = "shannon")

ggplot2::ggplot(df3, aes(x = shannon, fill = habitat1)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

ggplot(df3, aes(x = shannon, fill = habitat2)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

# Test de Kruskal-Wallis 
kruskal.test(shannon ~ habitat1, data = df3) #üî¥ Pas de diff√©rences significatives
kruskal.test(shannon ~ habitat2, data = df3) #üî¥ Pas de diff√©rences significatives
```

```{r}
## Indice d'√©quitabilit√© de Pi√©lou
#Permet de mesurer la r√©partition des individus au sein des esp√®ce. La valeur de l‚Äôindice d‚Äô√©quitabilit√© de Pi√©lou (J) varie entre 0 et 1 o√π 0 correspond √† la dominance d‚Äôune des esp√®ces et 1 √† l‚Äô√©quir√©partition des individus entre les diff√©rentes esp√®ces.
df4 <- df3 %>% filter(shannon > 0) 
df4$pielou <- df4$shannon / log(df4$richesse)

ggplot2::ggplot(df4, aes(x = pielou, fill = habitat1)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

### Kruskal-Wallis
kruskal.test(pielou ~ habitat1, data = df4) #üî¥ Pas de diff√©rences significatives
kruskal.test(pielou ~ habitat2, data = df4) #üî¥ Pas de diff√©rences significatives
```

### Indice de Simpson

```{r}
## Indice de Simpon pour chaque habitat
# Mesure la probabilit√© que deux individus tir√©s au hasard √† partir d‚Äôun √©chantillon appartiennent √† la m√™me esp√®ce. Avec cet indice, on donne plus de poids aux esp√®ces abondantes par rapport aux esp√®ces rares. D√®s lors, l‚Äôajout d‚Äôune esp√®ce rare √† un √©chantillon ne modifiera pratiquement pas la valeur de l‚Äôindice de diversit√©.
# Cet indice tend donc vers 0 lorsque la diversit√© est minimale et vers 1‚àí(1/richesse sp√©) lorsque la diversit√© est maximale


# Calcul indice sous forme 1-indice de simpson comme √ßa plus √ßa se rapproche de 1 plus la diversit√© est grande plus c'est proche de 0 bah moins y a de diversit√© ATTENTION vegan calcule la forme 1-D par d√©faut donc pas besoin de corriger
ind_simpson <- vegan::diversity(mat_parasites[,c(1:8)], index = "simpson") 

mat_parasites$simpson_index <- ind_simpson
mat_parasites
```

```{r}
## Indice de Simpson calcul√© pour chaque individu
df3$simpson <- vegan::diversity(parasites, index = "simpson")

ggplot(df3, aes(x = simpson, fill = habitat1)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

ggplot(df3, aes(x = simpson, fill = habitat2)) +
  geom_histogram(bins = 15, position = "dodge") +
  theme_minimal()

# Test de Kruskal-Wallis 
kruskal.test(simpson ~ habitat1, data = df3) #üî¥ Pas de diff√©rences significatives
kruskal.test(simpson ~ habitat2, data = df3) #üî¥ Pas de diff√©rences significatives
```

## Comparaisons

```{r}
## Completer df avec donn√©es df3
df <- df %>%
  left_join(df3, by = c("code_rongeur","syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna","syphacia_frederici","hydatigera_parva","aspiculuris_tetraptera","skrjabinotaenia_lobata", "trichuris","numero_ligne","demogroup","sexe", "SMI", "poids", "longueur_tete_corps", "richesse_spe_AP", "habitat1", "habitat2","richesse"))%>%
  left_join(df4, by = c("code_rongeur","syphacia_stroma", "heligmosomoides_polygyrus", "hymenolepis_hiberna","syphacia_frederici","hydatigera_parva","aspiculuris_tetraptera","skrjabinotaenia_lobata", "trichuris","numero_ligne","demogroup","sexe", "SMI", "poids", "longueur_tete_corps", "richesse_spe_AP", "habitat1", "habitat2","richesse","shannon"))

```

```{r}
wilcox.test(richesse ~ sexe, data = df)
kruskal.test(richesse ~ habitat1, data = df)
kruskal.test(richesse ~ habitat2, data = df)
kruskal.test(shannon ~ habitat1, data = df)
kruskal.test(shannon ~ sexe, data = df)
kruskal.test(simpson ~ habitat1, data = df)
kruskal.test(simpson ~ sexe, data = df)
kruskal.test(SMI ~ habitat1, data = df)
```

### Diff√©rences significatives du poids entre habitats

```{r}
kruskal.test(poids ~ habitat1, data=df) #üî¥ significatif

pairwise.wilcox.test(df$poids,df$habitat1,p.adjust.method = "holm",paired = FALSE)
```

```{r}
by(df$poids, df$habitat1, summary)
```

```{r}
boxplot(poids ~ habitat1, data = df, 
        main = "Poids des mulots par habitat",
        xlab = "Habitat", 
        ylab = "Poids")
```

### Diff√©rences significatives de la richesse sp√©cifique est AP (hors helminthes) en fonction du paysage

```{r}
kruskal.test(richesse_spe_AP ~ habitat1, data = df)
```

```{r}
pairwise.wilcox.test(df$richesse_spe_AP,df$habitat1,p.adjust.method = "holm",paired = FALSE)
```

```{r}
by(df$richesse_spe_AP, df$habitat1, summary)
```

```{r}
boxplot(richesse_spe_AP ~ habitat1, data = df, 
        main = "Poids des mulots par habitat",
        xlab = "Habitat", 
        ylab = "Poids")
```
